name: æ¯æ—¥æ›´æ–°å°è¯´å¹¶å‘å¸ƒ

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼ˆUTC 0ç‚¹ï¼‰æ‰§è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt

      - name: æ¢å¤ä¸Šæ¬¡ä¸‹è½½çŠ¶æ€
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            state.json
            output/
          key: novel-state-${{ github.run_number }}
          restore-keys: |
            novel-state-

      - name: ä¸‹è½½å°è¯´
        id: download
        run: python -u download_novels.py

      - name: æ£€æŸ¥ä¸‹è½½ç»“æœ
        id: check
        run: |
          if [ -d "output" ] && [ "$(find output -name '*.txt' | wc -l)" -gt 0 ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
            FILE_COUNT=$(find output -name '*.txt' | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ° $FILE_COUNT ä¸ªå°è¯´æ–‡ä»¶"
            find output -name '*.txt' -exec ls -lh {} \;
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "âŒ æ²¡æœ‰ä¸‹è½½åˆ°ä»»ä½•å°è¯´æ–‡ä»¶"
          fi

      - name: è·å–ä¸Šæ¬¡Releaseçš„ä¿¡æ¯
        if: steps.check.outputs.has_files == 'true'
        id: prev
        run: |
          PREV_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "is_first_release=true" >> $GITHUB_OUTPUT
            echo "prev_tag=" >> $GITHUB_OUTPUT
          else
            echo "is_first_release=false" >> $GITHUB_OUTPUT
            echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡Releaseä¿¡æ¯
        if: steps.check.outputs.has_files == 'true'
        id: release_info
        run: |
          DATE=$(date +%Y%m%d)
          TIME=$(date +%H%M%S)
          TAG="v${DATE}-${TIME}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

          TOTAL_BOOKS='${{ steps.download.outputs.total_books }}'
          TOTAL_NOVELS='${{ steps.download.outputs.total_novels }}'

          {
            echo "body<<RELEASE_EOF"
            echo "## ğŸ“š å°è¯´è‡ªåŠ¨åŒæ­¥æ›´æ–°"
            echo ""
            echo "**æ›´æ–°æ—¶é—´**: ${DATE}"
            echo ""
            echo "**å¤„ç†ç»“æœ**: ${TOTAL_BOOKS}/${TOTAL_NOVELS} æœ¬æˆåŠŸ"
            echo ""
            echo "### ğŸ“– æœ¬æ¬¡æ›´æ–°çš„å°è¯´"
            echo ""
          } >> $GITHUB_OUTPUT

          for f in output/*.txt; do
            if [ -f "$f" ]; then
              BASENAME=$(basename "$f")
              SIZE=$(du -h "$f" | cut -f1)
              echo "- **${BASENAME%.txt}** (${SIZE})" >> $GITHUB_OUTPUT
            fi
          done

          {
            echo ""
            echo "---"
            echo ""
            echo "**æ•°æ®æº**: xbiqugu.laï¼ˆç¬”è¶£é˜ï¼‰"
            echo ""
            echo "> ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå‘å¸ƒ"
            echo "RELEASE_EOF"
          } >> $GITHUB_OUTPUT

      - name: å‘å¸ƒRelease
        if: steps.check.outputs.has_files == 'true'
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          gh release create "$TAG" \
            --title "ğŸ“š å°è¯´æ›´æ–° - ${{ steps.release_info.outputs.date }}" \
            --notes "${{ steps.release_info.outputs.body }}" \
            output/*.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†æ—§ç‰ˆæœ¬Releaseï¼ˆä»…ä¿ç•™æœ€æ–°3ä¸ªï¼‰
        if: steps.check.outputs.has_files == 'true'
        run: |
          TAGS=$(gh release list --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName')
          COUNT=0
          for TAG in $TAGS; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -gt 3 ]; then
              echo "åˆ é™¤æ—§ç‰ˆæœ¬: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¿å­˜çŠ¶æ€åˆ°ä»“åº“
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state.json novels.json 2>/dev/null || true
          git diff --cached --quiet || git commit -m "ğŸ“ æ›´æ–°ä¸‹è½½çŠ¶æ€ [skip ci]"
          git push || true

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: steps.check.outputs.has_files == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸ“– å°è¯´æ›´æ–°é€šçŸ¥ - ${{ steps.release_info.outputs.date }}"
          to: 282000500@qq.com
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            å°è¯´è‡ªåŠ¨åŒæ­¥æ›´æ–°é€šçŸ¥
            =====================

            ğŸ“… æ›´æ–°æ—¶é—´: ${{ steps.release_info.outputs.date }}
            ğŸ“Š å¤„ç†ç»“æœ: ${{ steps.download.outputs.total_books }}/${{ steps.download.outputs.total_novels }} æœ¬æˆåŠŸ

            ğŸ“¦ ä¸‹è½½çš„å°è¯´æ–‡ä»¶å·²å‘å¸ƒåˆ° GitHub Release

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: è¾“å‡ºè·³è¿‡ä¿¡æ¯
        if: steps.check.outputs.has_files != 'true'
        run: echo "ğŸ“Œ æ²¡æœ‰æˆåŠŸä¸‹è½½ä»»ä½•å°è¯´ï¼Œæœ¬æ¬¡è·³è¿‡å‘å¸ƒã€‚"
