name: æ¯æ—¥æ›´æ–°å°è¯´å¹¶å‘å¸ƒ

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼ˆUTC 0ç‚¹ï¼‰æ‰§è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ä¸‹è½½å¹¶æ¸…ç†å°è¯´
        id: download
        run: python clean_and_release.py

      - name: è·å–ä¸Šæ¬¡Releaseçš„ç« èŠ‚æ•°
        id: prev
        run: |
          # è·å–æœ€æ–°Releaseçš„tag
          PREV_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "prev_chapters=0" >> $GITHUB_OUTPUT
            echo "is_first_release=true" >> $GITHUB_OUTPUT
          else
            # ä»tagä¸­æå–ç« èŠ‚æ•°ï¼Œtagæ ¼å¼: vç« èŠ‚æ•°-æ—¥æœŸ
            PREV_CHAPTERS=$(echo "$PREV_TAG" | sed -n 's/^v\([0-9]*\)-.*/\1/p')
            if [ -z "$PREV_CHAPTERS" ]; then
              PREV_CHAPTERS=0
            fi
            echo "prev_chapters=$PREV_CHAPTERS" >> $GITHUB_OUTPUT
            echo "is_first_release=false" >> $GITHUB_OUTPUT
          fi
          echo "ä¸Šæ¬¡ç« èŠ‚æ•°: $PREV_CHAPTERS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¡ç®—æ–°å¢ç« èŠ‚å¹¶å‡†å¤‡Releaseä¿¡æ¯
        id: release_info
        run: |
          CURRENT=${{ steps.download.outputs.total_chapters }}
          PREV=${{ steps.prev.outputs.prev_chapters }}
          NEW_CHAPTERS=$((CURRENT - PREV))
          DATE=$(date +%Y%m%d)
          TAG="v${CURRENT}-${DATE}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "new_chapters=$NEW_CHAPTERS" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

          # å¦‚æœç« èŠ‚æ•°æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ
          if [ "$NEW_CHAPTERS" -le 0 ] && [ "${{ steps.prev.outputs.is_first_release }}" = "false" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "ç« èŠ‚æ•°æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºReleaseè¯´æ˜
        if: steps.release_info.outputs.skip == 'false'
        id: notes
        run: |
          TITLE="${{ steps.download.outputs.title }}"
          AUTHOR="${{ steps.download.outputs.author }}"
          STATUS="${{ steps.download.outputs.status }}"
          CURRENT="${{ steps.download.outputs.total_chapters }}"
          NEW="${{ steps.release_info.outputs.new_chapters }}"
          DATE="${{ steps.release_info.outputs.date }}"
          IS_FIRST="${{ steps.prev.outputs.is_first_release }}"

          {
            echo "body<<RELEASE_EOF"
            echo "## ğŸ“– ${TITLE}"
            echo ""
            echo "**ä½œè€…**: ${AUTHOR}"
            echo ""
            echo "**çŠ¶æ€**: ${STATUS}"
            echo ""
            echo "**å½“å‰ç« èŠ‚æ•°**: ç¬¬${CURRENT}ç« "
            echo ""
            if [ "$IS_FIRST" = "true" ]; then
              echo "**é¦–æ¬¡å‘å¸ƒ** ğŸ‰"
            else
              echo "**æœ¬æ¬¡æ–°å¢**: ${NEW} ç« "
            fi
            echo ""
            echo "---"
            echo ""
            echo "**æ¥æº**: https://down7.ixdzs8.com/567128.zip"
            echo ""
            echo "**æ›´æ–°æ—¶é—´**: ${DATE}"
            echo "RELEASE_EOF"
          } >> $GITHUB_OUTPUT

      - name: å‘å¸ƒRelease
        if: steps.release_info.outputs.skip == 'false'
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          gh release create "$TAG" \
            --title "${{ steps.download.outputs.title }} - ${{ steps.release_info.outputs.date }}" \
            --notes "${{ steps.notes.outputs.body }}" \
            output/*.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†æ—§ç‰ˆæœ¬Releaseï¼ˆä»…ä¿ç•™æœ€æ–°2ä¸ªï¼‰
        if: steps.release_info.outputs.skip == 'false'
        run: |
          # è·å–æ‰€æœ‰releaseçš„tagï¼ŒæŒ‰æ—¶é—´å€’åº
          TAGS=$(gh release list --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[].tagName')
          COUNT=0
          for TAG in $TAGS; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -gt 2 ]; then
              echo "åˆ é™¤æ—§ç‰ˆæœ¬: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: steps.release_info.outputs.skip == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸ“– å°è¯´æ›´æ–°é€šçŸ¥ - ${{ steps.download.outputs.title }}"
          to: 282000500@qq.com
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            å°è¯´æ›´æ–°é€šçŸ¥
            ============

            ğŸ“– ${{ steps.download.outputs.title }}
            âœï¸ ä½œè€…: ${{ steps.download.outputs.author }}
            ğŸ“Š çŠ¶æ€: ${{ steps.download.outputs.status }}
            ğŸ“ å½“å‰ç« èŠ‚æ•°: ç¬¬${{ steps.download.outputs.total_chapters }}ç« 
            ğŸ†• æœ¬æ¬¡æ–°å¢: ${{ steps.release_info.outputs.new_chapters }} ç« 

            æ¥æº: https://down7.ixdzs8.com/567128.zip

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: è¾“å‡ºè·³è¿‡ä¿¡æ¯
        if: steps.release_info.outputs.skip == 'true'
        run: echo "ğŸ“Œ ç« èŠ‚æ•°æ²¡æœ‰æ›´æ–°ï¼Œæœ¬æ¬¡è·³è¿‡å‘å¸ƒã€‚"
